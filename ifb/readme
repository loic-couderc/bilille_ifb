############################################################
# install on Ubuntu 14.04 IFB-X2GO-10G (16.12) DEV4

# update os
#echo libc6 hold | sudo dpkg --set-selections #ignore libc6 which makes a mess
#apt-get update && apt-get -y upgrade

# setup docker
apt-get update
apt-get -y install apt-transport-https ca-certificates
apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D

echo deb https://apt.dockerproject.org/repo ubuntu-trusty main | tee /etc/apt/sources.list.d/docker.list
apt-get update
apt-get -y install linux-image-extra-$(uname -r) linux-image-extra-virtual
#apt-get -o Dpkg::Options::="--force-confnew" install -y docker-engine #to avoid answer this: docker (Y/I/N/O/D/Z) [default=N]
apt-get install -y docker-engine

# free some space
apt-get remove -y --purge x2go*
apt-get remove -y --purge xserver-xorg-core
apt-get remove -y --purge libreoffice-core libreoffice-common
apt-get remove -y --purge firefox
apt-get autoremove  -y --purge linux-image-extra-3.13.0-34-generic linux-image-extra-3.13.0-79-generic linux-image-3.13.0-34-generic linux-image-extra-3.13.0-79-generic
apt-get autoremove  -y --purge oxygen-icon-theme mysql-server-core-5.5
apt-get clean && apt-get autoremove --purge -y && reboot

# clone git repo
cd /ifb && git clone https://github.com/loic-couderc/bilille_ifb.git && cd bilille_ifb

# update config.in
sed -i 's|/tmp/crispr|/root/mydisk/bilille_ifb/crispr|' config.ini
sed -i 's|/tmp/websmash|/root/mydisk/bilille_ifb/websmash|' config.ini

# be sur to have installed all databases under /ifb/bilille_ifb/databases as mentionned here:  http://docs.antismash.secondarymetabolites.org/install/#antismash-standalone-lite
mkdir -p /root/mydisk/bilille_ifb/databases/pfam && cd /root/mydisk/bilille_ifb/databases/pfam
curl ftp://ftp.ebi.ac.uk/pub/databases/Pfam/releases/Pfam27.0/Pfam-A.hmm.gz > Pfam-A.hmm.gz
gunzip Pfam-A.hmm.gz && apt-get install hmmer && hmmpress Pfam-A.hmm
mkdir -p /root/mydisk/bilille_ifb/databases/clusterblast && cd /root/mydisk/bilille_ifb/databases/clusterblast
wget https://bitbucket.org/antismash/antismash/downloads/clusterblast_dmnd07.tar.xz
tar -xJf clusterblast_dmnd07.tar.xz && rm clusterblast_dmnd07.tar.xz

mkdir -p /ifb/bilille_ifb/databases/{pfam,clusterblast}
/bin/mount -o bind /root/mydisk/bilille_ifb/databases/pfam /ifb/bilille_ifb/databases/pfam
/bin/mount -o bind /root/mydisk/bilille_ifb/databases/clusterblast /ifb/bilille_ifb/databases/clusterblast

# build image (until we provide a repo)
docker volume ls -qf dangling=true | xargs -r docker volume rm
cd /ifb/bilille_ifb/
#docker build -t bilille .
# setup daemon
cp ifb/daemon/docker-bilille.conf /etc/init/docker-bilille.conf
initctl reload-configuration

# manually start the app (/var/log/upstart/docker-bilille.log if a pb occured)
initctl start docker-bilille